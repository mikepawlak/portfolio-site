name: E2E Tests
description: Run Playwright E2E tests and generate report

runs:
  using: "composite"
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install dependencies
      run: npm ci
      shell: bash

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
      shell: bash

    - name: Start Firebase Emulator
      run: |
        npm install -g firebase-tools
        npm install --prefix apps/functions
        npm run build --prefix apps/functions
        firebase emulators:start --only firestore,functions --project portfolio-mikepawlak --config firebase.json > emulators.log 2>&1 &
        sleep 15
      shell: bash

    - name: Serve Angular UI
      run: |
        npm run start:ui:ci &
        npx wait-on http://localhost:4200
      shell: bash

    - name: Run Playwright tests
      run: npm run e2e
      shell: bash

    - name: Upload e2e results
      uses: actions/upload-artifact@v4
      with:
        name: e2e-results-json
        path: coverage/e2e-results.json
        retention-days: 30
